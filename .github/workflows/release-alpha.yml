name: Release Alpha

on:
  workflow_dispatch:
    inputs:
      release_mode:
        description: 'Release mode'
        required: true
        type: choice
        options:
          - dry-run
          - publish
        default: dry-run
      publish_js:
        description: 'Publish npm packages'
        required: true
        type: boolean
        default: true
      publish_native:
        description: 'Publish native artifacts'
        required: true
        type: boolean
        default: false

jobs:
  validate-release-config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Validate Release Config (Standard)
        if: ${{ inputs.release_mode == 'dry-run' }}
        run: npm run validate:release-config
      - name: Validate Release Config (Strict)
        if: ${{ inputs.release_mode == 'publish' }}
        run: npm run validate:release-config:strict

  validate-native-android:
    needs:
      - validate-release-config
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'
      - uses: android-actions/setup-android@v3
      - name: Publish Core To Maven Local
        run: gradle -p native/android :core:test :core:publishCorePublicationToMavenLocal
      - name: Build Runtime Instrumentation APK
        run: gradle -p native/android :runtime:assembleDebugAndroidTest
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Run Runtime Instrumentation Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          profile: pixel_6
          script: gradle -p native/android :runtime:connectedDebugAndroidTest
      - name: Publish Android Runtime To Maven Local
        run: gradle -p native/android :runtime:assembleRelease :runtime:publishRuntimePublicationToMavenLocal
      - name: Publish FCM To Maven Local
        run: gradle -p native/android :fcm:assembleRelease :fcm:publishFcmPublicationToMavenLocal
      - name: Verify Maven Local Artifacts
        run: |
          test -f ~/.m2/repository/io/lynx/notifications/core/0.1.0-alpha/core-0.1.0-alpha.jar
          test -f ~/.m2/repository/io/lynx/notifications/android-runtime/0.1.0-alpha/android-runtime-0.1.0-alpha.aar
          test -f ~/.m2/repository/io/lynx/notifications/fcm/0.1.0-alpha/fcm-0.1.0-alpha.aar
      - name: Verify Host Consumption From Maven Local
        run: gradle -p native/android/host-check assembleDebug

  validate-native-ios:
    needs:
      - validate-release-config
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Build iOS FCM Target
        run: swift build --package-path native/ios --target LynxNotificationsFCM
      - name: Run iOS Core XCTest
        run: swift test --package-path native/ios --filter LynxNotificationsCoreTests

  publish-native-android:
    if: ${{ inputs.publish_native }}
    needs:
      - validate-release-config
      - validate-native-android
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'
      - uses: android-actions/setup-android@v3
      - name: Publish Android Native Artifacts (Dry Run)
        if: ${{ inputs.release_mode == 'dry-run' }}
        run: gradle -p native/android :core:publishCorePublicationToMavenLocal :runtime:publishRuntimePublicationToMavenLocal :fcm:publishFcmPublicationToMavenLocal
      - name: Validate Android Maven Credentials
        if: ${{ inputs.release_mode == 'publish' }}
        run: |
          test -n "${MAVEN_PUBLISH_URL}"
          test -n "${MAVEN_PUBLISH_USERNAME}"
          test -n "${MAVEN_PUBLISH_PASSWORD}"
      - name: Publish Android Native Artifacts
        if: ${{ inputs.release_mode == 'publish' }}
        run: gradle -p native/android :core:publishCorePublicationToRemoteRepository :runtime:publishRuntimePublicationToRemoteRepository :fcm:publishFcmPublicationToRemoteRepository
        env:
          MAVEN_PUBLISH_URL: ${{ secrets.MAVEN_PUBLISH_URL }}
          MAVEN_PUBLISH_USERNAME: ${{ secrets.MAVEN_PUBLISH_USERNAME }}
          MAVEN_PUBLISH_PASSWORD: ${{ secrets.MAVEN_PUBLISH_PASSWORD }}

  verify-native-android-remote-consumption:
    if: ${{ inputs.publish_native && inputs.release_mode == 'publish' }}
    needs:
      - validate-release-config
      - publish-native-android
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Resolve Notifications Version
        id: notifications-version
        run: echo "value=$(node -p \"require('./packages/core/package.json').version\")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.10.2'
      - uses: android-actions/setup-android@v3
      - name: Validate Android Maven Credentials
        run: |
          test -n "${MAVEN_PUBLISH_URL}"
          test -n "${MAVEN_PUBLISH_USERNAME}"
          test -n "${MAVEN_PUBLISH_PASSWORD}"
        env:
          MAVEN_PUBLISH_URL: ${{ secrets.MAVEN_PUBLISH_URL }}
          MAVEN_PUBLISH_USERNAME: ${{ secrets.MAVEN_PUBLISH_USERNAME }}
          MAVEN_PUBLISH_PASSWORD: ${{ secrets.MAVEN_PUBLISH_PASSWORD }}
      - name: Verify Host Consumption From Remote Maven
        run: |
          gradle -p native/android/host-check \
            -PlynxNotificationsUseMavenLocal=false \
            -PlynxNotificationsMavenUrl="${MAVEN_PUBLISH_URL}" \
            -PlynxNotificationsMavenUsername="${MAVEN_PUBLISH_USERNAME}" \
            -PlynxNotificationsMavenPassword="${MAVEN_PUBLISH_PASSWORD}" \
            -PlynxNotificationsVersion="${LYNX_NOTIFICATIONS_VERSION}" \
            assembleDebug
        env:
          MAVEN_PUBLISH_URL: ${{ secrets.MAVEN_PUBLISH_URL }}
          MAVEN_PUBLISH_USERNAME: ${{ secrets.MAVEN_PUBLISH_USERNAME }}
          MAVEN_PUBLISH_PASSWORD: ${{ secrets.MAVEN_PUBLISH_PASSWORD }}
          LYNX_NOTIFICATIONS_VERSION: ${{ steps.notifications-version.outputs.value }}

  publish-native-ios:
    if: ${{ inputs.publish_native }}
    needs:
      - validate-release-config
      - validate-native-ios
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install CocoaPods
        run: |
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods
          fi
          pod --version
      - name: CocoaPods Lint (Dry Run)
        if: ${{ inputs.release_mode == 'dry-run' }}
        run: |
          cd native/ios
          pod lib lint LynxNotificationsCore.podspec --allow-warnings --skip-tests --quick
          pod lib lint LynxNotificationsFCM.podspec --allow-warnings --skip-tests --quick
        env:
          LYNX_NOTIFICATIONS_HOMEPAGE: ${{ vars.LYNX_NOTIFICATIONS_HOMEPAGE }}
          LYNX_NOTIFICATIONS_IOS_SOURCE_GIT: ${{ vars.LYNX_NOTIFICATIONS_IOS_SOURCE_GIT }}
          LYNX_NOTIFICATIONS_AUTHOR_NAME: ${{ vars.LYNX_NOTIFICATIONS_AUTHOR_NAME }}
          LYNX_NOTIFICATIONS_AUTHOR_EMAIL: ${{ vars.LYNX_NOTIFICATIONS_AUTHOR_EMAIL }}
      - name: Validate CocoaPods Credentials
        if: ${{ inputs.release_mode == 'publish' }}
        run: test -n "${COCOAPODS_TRUNK_TOKEN}"
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      - name: Publish CocoaPods Specs
        if: ${{ inputs.release_mode == 'publish' }}
        run: |
          cd native/ios
          pod trunk push LynxNotificationsCore.podspec --allow-warnings --skip-tests
          pod trunk push LynxNotificationsFCM.podspec --allow-warnings --skip-tests
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
          LYNX_NOTIFICATIONS_HOMEPAGE: ${{ vars.LYNX_NOTIFICATIONS_HOMEPAGE }}
          LYNX_NOTIFICATIONS_IOS_SOURCE_GIT: ${{ vars.LYNX_NOTIFICATIONS_IOS_SOURCE_GIT }}
          LYNX_NOTIFICATIONS_AUTHOR_NAME: ${{ vars.LYNX_NOTIFICATIONS_AUTHOR_NAME }}
          LYNX_NOTIFICATIONS_AUTHOR_EMAIL: ${{ vars.LYNX_NOTIFICATIONS_AUTHOR_EMAIL }}

  publish-js:
    if: ${{ inputs.publish_js }}
    needs:
      - validate-release-config
      - validate-native-android
      - validate-native-ios
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm
      - name: Install dependencies
        run: npm install
      - name: Validate
        run: |
          npm run test:packages
          npm run build:packages
      - name: npm Publish Dry Run
        if: ${{ inputs.release_mode == 'dry-run' }}
        run: npm run release:alpha:dry-run
      - name: Publish @lynx-notifications/core (alpha)
        if: ${{ inputs.release_mode == 'publish' }}
        run: npm publish --workspace @lynx-notifications/core --tag alpha --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish lynx-notifications CLI (alpha)
        if: ${{ inputs.release_mode == 'publish' }}
        run: npm publish --workspace lynx-notifications --tag alpha --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
